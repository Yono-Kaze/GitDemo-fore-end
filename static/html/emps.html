<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title></title>
  	<!-- 引入jquery 1，文件引入的先后顺序，应该先引入jquery再引入bootstrap，也就是把这两个文件的出现顺序换一下。-->
	<script type="text/javascript" src="../js/jquery-3.5.1.min.js"></script>
	<!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script src="../bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
	<!-- 引入Bootstrap样式 -->
	<link href="../bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet">

	</head>
	<body>
	<!-- 员工添加的模块框 -->
	<div class="modal fade" id="empAddModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	        <h4 class="modal-title" id="myModalLabel">员工添加</h4>
	      </div>
	      <div class="modal-body">
	        <form class="form-horizontal">
			  <div class="form-group">
			    <label for="inputEmail3" class="col-sm-2 control-label">员工姓名</label>
			    <div class="col-sm-10">
			      <input type="text" name="empname" class="form-control" id="empName_add_input">
			      <span id="helpBlock2" class="help-block"></span>
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="inputEmail3" class="col-sm-2 control-label">性别</label>
			    <div class="col-sm-10">
					<label class="radio-inline">
					  <input type="radio" name="sex" id="gender1_add_input" value="0" checked="checked"> 男
					</label>
					<label class="radio-inline">
					  <input type="radio" name="sex" id="gender2_add_input" value="1"> 女
					</label>
			    </div>
			  </div>  
			  <div class="form-group">
			    <label for="inputEmail3" class="col-sm-2 control-label">出生日期</label>
			    <div class="col-sm-10">
			      <input type="date"  name="date" class="form-control" id="date_add_input" value="2020-02-13">
			      <span id="helpBlock2" class="help-block"></span>
			    </div>
			  </div>	  
			  <div class="form-group">
			    <label for="inputEmail3" class="col-sm-2 control-label">电话</label>
			    <div class="col-sm-10">
			      <input type="text"  name="phone" class="form-control" id="phone_add_input"  oninput = "value=value.replace(/[^\d]/g,'')">
			      <span id="helpBlock2" class="help-block"></span>
			    </div>
			  </div>		
			  <div class="form-group">
			    <label for="inputEmail3" class="col-sm-2 control-label">部门</label>
			    <div class="col-sm-4">
					<select class="form-control" name="did" id="dept_add_select">
					<!-- 部门提交部门id即可 -->
					</select>
			    </div>
			  </div>
			</form>
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
	        <button type="button" class="btn btn-primary"  id="emp_save_btn">保存</button>
	      </div>	      
	    </div>
	  </div>
	</div>
	
	
	<!-- 员工修改的模块框 -->
	<div class="modal fade" id="empUpdateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	        <h4 class="modal-title" id="myModalLabel">员工修改</h4>
	      </div>
	      <div class="modal-body">
	        <form class="form-horizontal">
			  <div class="form-group">
			    <label for="inputEmail3" class="col-sm-2 control-label">员工姓名</label>
			    <div class="col-sm-10">
			      <p class="form-control-static" id="empName_update_static"></p>
			      <span id="helpBlock2" class="help-block"></span>
			    </div>
			  </div>
			  <div class="form-group">
			    <label for="inputEmail3" class="col-sm-2 control-label">性别</label>
			    <div class="col-sm-10">
					<label class="radio-inline">
					  <input type="radio" name="sex" id="gender1_update_input" value="0" checked="checked"> 男
					</label>
					<label class="radio-inline">
					  <input type="radio" name="sex" id="gender2_update_input" value="1"> 女
					</label>
			    </div>
			  </div>  
			  <div class="form-group">
			    <label for="inputEmail3" class="col-sm-2 control-label">出生日期</label>
			    <div class="col-sm-10">
			      <input type="date"  name="date" class="form-control" id="date_update_input" >
			      <span id="helpBlock2" class="help-block"></span>
			    </div>
			  </div>	  
			  <div class="form-group">
			    <label for="inputEmail3" class="col-sm-2 control-label">电话</label>
			    <div class="col-sm-10">
			      <input type="text"  name="phone" class="form-control" id="phone_update_input" oninput = "value=value.replace(/[^\d]/g,'')">
			      <span id="helpBlock2" class="help-block"></span>
			    </div>
			  </div>		
			  <div class="form-group">
			    <label for="inputEmail3" class="col-sm-2 control-label">部门</label>
			    <div class="col-sm-4">
					<select class="form-control" name="did" id="dept_update_select">
					<!-- 部门提交部门id即可 -->
					</select>
			    </div>
			  </div>
			</form>
	      </div>
	      <div class="modal-footer">
	     	 
	        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
	        <button type="button" class="btn btn-primary"  id="emp_update_btn">修改</button>    
	      </div>
	    </div>
	  </div>
	</div>
	
	
		<!-- 搭建平台显示页面 -->
		<div class="container">
			<!-- 标题 -->
			<div class="row">
				<div class="col-md-12">
					<h1>员工管理系统-员工部分</h1>
				</div>
			</div>
			
			<!-- 按钮 -->
			<div class="row">
				<div class="col-md-4">
					<a class="btn btn-default btn-info" href="depts.html" role="button">部门管理</a>
					<a class="btn btn-default btn-danger" href="../../Main.html" role="button">退出</a>	
				</div>
				<div class="col-md-4 col-md-offset-8">
					<button class="btn btn-info" id="emp_add_model_btn">新增</button>
					<button class="btn btn-danger" id="emp_delete_all_btn">删除</button>		
				</div>
			</div>
			
			<!-- 显示表格 -->
			<div class="row">
				<div class="col-md-12">
				<table class="table table-hover" id="emps_table">
					<thead>
						<tr>
							<th>
								<input type="checkbox" id="check_all"/>
							</th>
							<th>员工ID</th>
							<th>员工姓名</th>
							<th>员工性别</th>
							<th>出生日期</th>
							<th>员工电话</th>
							<th>部门</th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody>
					<!-- 员工信息显示处 -->
					</tbody>
				</table>		
				</div>
			</div>
			
			<!-- 显示分页信息 -->
			<div class="row">
				<!-- 分页文字信息 -->
				<div class="col-md-6" id="page_info_area">
		
				</div>
				
				<!-- 分页条信息 -->
				<div class="col-md-6" id="page_nav_area">
				
				</div>
			</div>
		</div>
		
		<script type="text/javascript">
			//记录总记录数和当前页数 
			var totalRecord,currentPage;
			
			//默认加载页面时候跳转到首页
			$(function(){
				to_page(1);
			});
			
			
			
			
		    /* 页面加载完成以后，直接发送一个ajax请求，要求到数据 */
			function to_page(pn){
				$.ajax({
					url:"http://localhost:8001/emps",
					data:"pn="+pn,
					type:"GET",
					success:function(result){
						//console.log(result);
						//1.解析json并显示员工数据
							bulid_emps_table(result);
						//2.解析json并显示分页信息
							bulid_page_info(result);
						//3.解析json并显示分页条信息
							build_page_nav(result);
					}
				});
			}
		    
		    ///将获取到的时间字符串进行格式化
		    function dateToString(date){
		    	var str=date.split("-");
		    	return str[0]+"年"+str[1]+"月"+str[2]+"日";
		    }
		    
		    
		    //解析员工数据
		    function bulid_emps_table(result){
		    	//首先要清空table表
		    	$("#emps_table tbody").empty();
		    	///获取result中用户数据
		    	var emps=result.extend.pageInfo.list;
		    	//遍历list列表
		    	$.each(emps,function(index,item){
		    		//单选框构建
		    		var checkBoxTd=$("<td><input type='checkbox' class='check_item'/></td>");
		    		//员工Id列构建
		    		var empIdTd=$("<td></td>").append(item.empid);
		    		//员工姓名列构建
		    		var empNameTd=$("<td></td>").append(item.empname);
		    		//员工性别列构建
		    		var sexTd=$("<td></td>").append(item.sex==0?"男":"女");
		    		//员工出生日列构建
		    		var dateTd=$("<td></td>").append(dateToString(item.date));
		    		//员工电话列构建
		    		var phoneTd=$("<td></td>").append(item.phone);
		    		//部门名称列构建
		    		var deptnameTd=$("<td></td>").append(item.department.deptname);
		    		//操作列构建
		    		//编辑按钮构建
		    		var editBtn=$("<button></button>").addClass("btn btn-info btn-sm edit_btn")
		    					.append($("<span></span>").addClass("glyphicon glyphicon-pencil"))
		    					.append("编辑");
		    					//给编辑按钮添加一个自定义属性，来表示当前员工id
		    					editBtn.attr("edit-id",item.empid);
			    	//删除按钮构建
			    	var delBtn=$("<button></button>").addClass("btn btn-danger btn-sm delete_btn")
			    				.append($("<span></span>").addClass("glyphicon glyphicon-trash"))
			    				.append("删除");
		    					//给删除按钮添加一个自定义属性，来表示当前员工id 
		    					delBtn.attr("del-id",item.empid);
		    		//将两个按钮合并到一个td中
		    		var btnTd=$("<td></td>").append(editBtn).append(" ").append(delBtn);
		    					
		    		//将构建的元素添加到页面中的tbody
			    	$("<tr></tr>").append(checkBoxTd)
			    		.append(empIdTd)
			    		.append(empNameTd)
			    		.append(sexTd)
			    		.append(dateTd)
			    		.append(phoneTd)
			    		.append(deptnameTd)
			    		.append(btnTd)
			    		.appendTo("#emps_table tbody");		
		    		
		    		
		    	});
		    }
		    
		    //解析分页信息
		    function bulid_page_info(result){
				//page_info
				//清空分页信息
				$("#page_info_area").empty();
				$("#page_info_area").append("当前"+result.extend.pageInfo.pageNum+"页，总"+
						result.extend.pageInfo.pages+"页,总共"+
						result.extend.pageInfo.total+"条记录");	
				totalRecord=result.extend.pageInfo.total;
				currentPage=result.extend.pageInfo.pageNum;			
		    }
		    
		    //解析分页条信息,可以进行页面跳转操作
		    function build_page_nav(result){
		    	//清空分页条信息
				$("#page_nav_area").empty();	    	
				var ul=$("<ul></ul>").addClass("pagination");	    
				//构建首页元素,构建前一页元素
				var firspPageLi=$("<li></li>")
						.append($("<a></a>").append("首页").attr("href","#"));
				var prePageLi=$("<li></li>")
						.append($("<a></a>").append("&laquo;"));
					//判断前一页是否还有页数 
					if(result.extend.pageInfo.hasPreviousPage==false){
						//若没有，禁止前一页元素
						firspPageLi.addClass("disabled");
						prePageLi.addClass("disabled");
					}else{
						//为元素添加翻页事件
						firspPageLi.click(function(){
							to_page(1);
						});
						prePageLi.click(function(){
							to_page(result.extend.pageInfo.pageNum-1);
						});	
					};
				//构建后一页元素,构建末页元素
				var nextPageLi=$("<li></li>")
						.append($("<a></a>").append("&raquo;"));
				var lastPageLi=$("<li></li>")
				.append($("<a></a>").append("末页").attr("href","#"));
					//判断后一页是否还有页数
					if(result.extend.pageInfo.hasNextPage==false){
						//若无，禁止翻页
						nextPageLi.addClass("disabled");
						lastPageLi.addClass("disabled");
					}else{
						//若有，添加翻页事件
						lastPageLi.click(function(){
							to_page(result.extend.pageInfo.pages);
						});
						nextPageLi.click(function(){
							to_page(result.extend.pageInfo.pageNum+1);
						});				
					};
			
					//将首页和前一页添加到页面中
					ul.append(firspPageLi).append(prePageLi);
					//构建中间页元素
					$.each(result.extend.pageInfo.navigatepageNums,function(index,item){
						
						var numLi =	$("<li></li>").append($("<a></a>").append(item));
						if(result.extend.pageInfo.pageNum==item){
							numLi.addClass("active");
						};
						numLi.click(function(){
							to_page(item);
						});
						ul.append(numLi);
					});
					
					//添加下一页和末页的提示
					ul.append(nextPageLi).append(lastPageLi);
					var navEle=$("<nav></nav>").append(ul);
					navEle.appendTo("#page_nav_area");	
				
		    }
		    
		    //重置表单内容的事件
			function reset_form(ele){
				//重置表单内容
				$(ele)[0].reset();
				//重置表单样式
				$(ele).find("*").removeClass("has-error has-success");
				$(ele).find(".help-block").text("");
			};
			
			//查出所有部门信息，并显示在下拉列表中 
			function getDepts(ele){
				//清空之前的下拉列表的值
				$(ele).empty();
				$.ajax({
					url:"http://localhost:8001/depts",
					type:"GET",
					success:function(result){
						/* console.log(result) */
						//显示在下拉框中
						/* $("#dept_add_select").append */
						$.each(result.extend.depts,function(){
							var optionEle=$("<option></option>")
							.append(this.deptname).attr("value",this.deptid);
							optionEle.appendTo(ele);
						});
					}
				});
			}
			
		    //给新增按钮弹出模态框
			$("#emp_add_model_btn").click(function(){
				//表单重置(样式，数据)
				reset_form("#empAddModal form");
				//发送ajax请求，查出部门信息，显示在下拉列表中
				getDepts("#dept_add_select");
				//弹出模态框
				$("#empAddModal").modal({
					backdrop:"static"
				});
			});
		    
		    
		    /* 发送数据前进行表单校验---------------------------------- */
		    
		    //发送ajax请求前校验用户名是否可用
			$("#empName_add_input").change(function(){
				//发送ajax请求校验用户名是否可用
				var empName=this.value;
				$.ajax({
					url:"http://localhost:8001/checkuser",
					data:"empName="+empName,
					success:function(result){
						if(result.code==100){
							show_validate_msg("#empName_add_input","success","用户名可用");
							$("#emp_save_btn").attr("ajax-va","success");
						}else{
							show_validate_msg("#empName_add_input","error",result.extend.va_msg);
							$("#emp_save_btn").attr("ajax-va","error");
						}
					}
				});
			});	    
		    //校验电话号码是否合法
		    $("#phone_add_input").change(function(){
				var Phone=$("#phone_add_input").val();
				var regPhone=/^[0-9_-]{3,11}$/;
				if(!regPhone.test(Phone)){
					show_validate_msg("#phone_add_input","error","电话只能由纯数字的3-11位组成 ");
					$("#emp_save_btn").attr("ajax-va","error");
	
				}else{
					show_validate_msg("#phone_add_input","success","");
					$("#emp_save_btn").attr("ajax-va","success");
					
				}
		    	
		    });
		    $("#phone_update_input").change(function(){
				var Phone=$("#phone_update_input").val();
				var regPhone=/^[0-9_-]{3,11}$/;
				if(!regPhone.test(Phone)){
					show_validate_msg("#phone_update_input","error","电话只能由纯数字的3-11位组成 ");
					$("#emp_update_btn").attr("ajax-va","error");
	
				}else{
					show_validate_msg("#phone_update_input","success","");
					$("#emp_update_btn").attr("ajax-va","success");
					
				}
		    	
		    });
		    
		    
		    //显示校验结果的提示信息
			function show_validate_msg(ele,status,msg){
				//清除当前元素的校验状态
				$(ele).parent().removeClass("has-success has-error");
				$(ele).next("span").text("");
				if("success"==status){
					$(ele).parent().addClass("has-success");
					$(ele).next("span").text(msg);
					
				}else if("error"==status){
					$(ele).parent().addClass("has-error");
					$(ele).next("span").text(msg);
				}
		    }   
		    /* 发送数据前进行表单校验---------------------------------------- */
		    
		    $("#emp_save_btn").click(function(){
		    	//1.将模态框数据提交给服务器进行保存
		    	//2.先对提交给服务器的数据进行校验
				if($("#empName_add_input").parent().hasClass("has-error")||$("#phone_add_input").parent().hasClass("has-error")){
					$("#emp_save_btn").attr("ajax-va","error");
				};					
				if($(this).attr("ajax-va")=="error"){
					return false;
				};
		    	//3.校验用用户名是否重复
		    	//4.发送ajax请求保存员工
		    	$.ajax({
					url:"http://localhost:8001/emp",
					type:"POST",
					data:$("#empAddModal form").serialize(),
					success:function(result){
					//	alert(result.msg);
						if(result.code==100){
							
							//关闭模态框
							$('#empAddModal').modal('hide');
							//跳转到最后一页
							to_page(totalRecord);	
						}else{
							//显示失败信息
						//	console.log(result);
							//有哪个字段的错误信息就显示哪个字段
							if(undefined !=result.extend.errorFields.empname){
								//显示员工姓名错误信息
								show_validate_msg("#empName_add_input","error",result.extend.errorFields.empname)
							}
							if(undefined !=result.extend.errorFields.phone){
								//显示员工姓名错误信息
								show_validate_msg("#phone_add_input","error",result.extend.errorFields.phone)
							}								
						}
	
					}
				}); 
		    	
		    	
		    });
		    
		    
		    
	
		    
		    
		  //查出员工信息，显示
		    function getEmp(id){
				$.ajax({
					url:"http://localhost:8001/emp/"+id,
					type:"GET",
					success:function(result){
					//	console.log(result);
					var empData=result.extend.emp;
					$("#empName_update_static").text(empData.empname);
					$("#empUpdateModal input[name=sex]").val([empData.sex]);
					$("#date_update_input").val([empData.date]);
					console.log(empData.date);
					$("#phone_update_input").val([empData.phone]);
					$("#empUpdateModal select").val([empData.did]);
					
					}
				});
			}
		    
		    
			//为编辑按钮绑定事件,注按钮是在页面加载后被创建的，所以在创建之前绑定click事件是无法绑定
			$(document).on("click",".edit_btn",function(){
				/* alert("edas"); */
	
				//1.查询部门信息，显示
				getDepts("#dept_update_select");
				//2.查出员工信息，显示
				getEmp($(this).attr("edit-id"));
				//3.传递员工的id给模态框
				$("#emp_update_btn").attr("edit-id",$(this).attr("edit-id"));
				//弹出模态框
				$("#empUpdateModal").modal({
					backdrop:"static"
				});
	
			});
			
		    //点击更新，更新员工信息 
		    $("#emp_update_btn").click(function(){
		    	//校验数据 
				if($(this).attr("ajax-va")=="error"){
					return false;
				};
		    	//发送ajax请求，更新员工数据 
		    	$.ajax({
					url:"http://localhost:8001/emp/"+$(this).attr("edit-id"),
					type:"PUT",

					data: $("#empUpdateModal form").serialize(),
					success:function(result){
						alert(result.msg);
						//1.关闭对话框
						$("#empUpdateModal").modal("hide");
						//2.回到本页面
						to_page(currentPage);
					}
		    	});
		    	
		    });
		 	 //为删除按钮绑定事件
			$(document).on("click",".delete_btn",function(){
				//1.弹出是否删除对话框
				var empName=$(this).parents("tr").find("td:eq(2)").text();
				/* alert($(this).parents("tr").find("td:eq(1)").text()); */
				var empId=$(this).attr("del-id");
				if(confirm("确认删除["+empName+"]吗?")){
					$.ajax({
						url:"http://localhost:8001/emp/"+empId,
						type:"DELETE",
						success:function(result){
							alert(result.msg);
							//回到本页
							to_page(currentPage);
						}
					});		
				}
			}); 
		 	 
			//完成全选,全不选
			$("#check_all").click(function(){
				//attr获取checked是undefined,dom原生的属性使用prop，自定义用attr
				$(".check_item").prop("checked",$(this).prop("checked"));
			});
			//check_item
			$(document).on("click",".check_item",function(){
				//判断当前选择中的元素是否5个
				var flag=$(".check_item:checked").length==$(".check_item").length;
				$("#check_all").prop("checked",flag);
			});
			//点击全部删除，批量删除
			$("#emp_delete_all_btn").click(function(){
				var empNames="";
				var del_idstr="";
				$.each($(".check_item:checked"),function(){
					empNames += $(this).parents("tr").find("td:eq(2)").text()+",";
					//组装员工id字符串
					del_idstr += $(this).parents("tr").find("td:eq(1)").text()+"-";
				});
				//去除empNames多余的，
				empNames=empNames.substring(0,empNames.length-1);
				//去除empNames多余的-
				del_idstr=del_idstr.substring(0,del_idstr.length-1);
				if(confirm("确认删除["+empNames+"]吗?")){
					//发送ajax请求删除
					$.ajax({
						url:"http://localhost:8001/emp/"+del_idstr,
						type:"DELETE",
						success:function(result){
							alert(result.msg);
							//回到当前页
							to_page(currentPage);
						}
						
					});
					
				}
			});
			
		</script>
		
		
	
	
	</body>
</html>
